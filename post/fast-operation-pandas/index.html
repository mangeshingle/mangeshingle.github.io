
<!DOCTYPE html>
<html lang="en-us">

<!-- Mirrored from www.albertauyeung.com/post/fast-operation-pandas/ by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 02 Nov 2018 14:48:01 GMT -->
<head>

  
  <meta charset="UTF-8">
  <title>
    Making pandas Operations Faster | Albert Au Yeung
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">

  
  <link rel="canonical" href="index.html"/>

  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans">
  <link rel="stylesheet" href="../../css/sanitize.css">
  <link rel="stylesheet" href="../../css/responsive.css">
  <link rel="stylesheet" href="../../css/highlight.css">
  <link rel="stylesheet" href="../../css/theme.css">
  <link rel="stylesheet" href="../../css/custom.css">
  
  
  <link href="../../index.xml" rel="alternate" type="application/rss+xml" title="Albert Au Yeung" />
  <link href="../../index.xml" rel="feed" type="application/rss+xml" title="Albert Au Yeung" />

  
  


</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="../../index.html">Albert Au Yeung</a></h1>
        <h2>Notes on machine learning and A.I.</h2>
      </div>
      <div id="social" class="col span_6">
        <ul>
          <li><a href="../../about/index.html">About</a></li>
          <li><a href="../index.html">Archive</a></li>
          <li><a href="https://github.com/albertauyeung" target="_blank">Github</a></li>
          <li><a href="https://www.linkedin.com/in/albert-au-yeung/" target="_blank">LinkedIn</a></li>
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>Making pandas Operations Faster</h1>
      <div class="meta">
        
        Jul 8, 2017 &nbsp;
        
        
      </div>
    </div>
    <article>
      

<p><a href="http://pandas.pydata.org/">pandas</a> is one of the most commonly used Python library in data analysis and machine learning. It is versatile and can be used to handle many different types of data. Before feeding a model with training data, one would most probably pre-process the data and perform feature extraction on data stored as pandas <code>DataFrame</code>. I have been using pandas extensively in my work, and have recently discovered that the time required to manipulate data stored in a <code>DataFrame</code> can vary hugely depending on the method you used.</p>

<h2 id="numerical-operations">Numerical Operations</h2>

<p>To demonstrate the differences, let&rsquo;s generate some random data first. The following block of code will generate a <code>DataFrame</code> with 5,000 rows and 3 columns (<code>A</code>, <code>B</code> and <code>C</code>) with values ranging from -10 to 10.</p>

<pre><code class="language-python">In [1]: import pandas as pd
In [2]: import numpy as np
In [3]: data = np.random.randint(-10, 10, (5000, 3))
In [4]: df = pd.DataFrame(data=data, columns=[&quot;A&quot;, &quot;B&quot;, &quot;C&quot;], index=None)
</code></pre>

<p>To track the time required to finish an operation, we can make use of the IPython magic function <a href="https://ipython.org/ipython-doc/3/interactive/magics.html#magic-timeit"><code>%timeit</code></a> to measure the time required to execute a line in Python.</p>

<p>To start with, let&rsquo;s consider a simple task of creating a new column in the DataFrame, whose values depend on whether the sum of the values in other columns are greater than zero. First, let&rsquo;s try using the <code>apply</code> function of the DataFrame:</p>

<pre><code class="language-python">In [5]: %timeit df[&quot;D&quot;] = df.apply(lambda x: 1 if x[&quot;A&quot;] + x[&quot;B&quot;] + x[&quot;C&quot;] &gt; 0 else 0, axis=1)
134 ms ± 1.59 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
</code></pre>

<p>It takes about 134ms to finish the operation, which seems quite fast. However, if we take another approach by using numpy&rsquo;s <code>where()</code> function, we can actually be much faster:</p>

<pre><code class="language-python">In [6]: %timeit df[&quot;E&quot;] = np.where(df[&quot;A&quot;] + df[&quot;B&quot;] + df[&quot;C&quot;] &gt; 0, 1, 0)
757 µs ± 38.8 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
</code></pre>

<p>This is ~170 times faster! We can verified that the two methods actually give the same results as follows. (<code>np.any</code> checks if any of the values in a list is <code>True</code>).</p>

<pre><code class="language-python">In [7]: np.any(df[&quot;D&quot;] != df[&quot;E&quot;])
False
</code></pre>

<h2 id="string-operations">String Operations</h2>

<p>As another example, let&rsquo;s try searching substrings in a column. Firstly, let&rsquo;s generate some random text data in a new column:</p>

<pre><code class="language-python">In [8]: df[&quot;F&quot;] = np.random.choice([&quot;apple&quot;, &quot;banana&quot;, &quot;orange&quot;, &quot;pear&quot;], 5000)
</code></pre>

<p>Let&rsquo;s say we want to create a new column, whose values depend on whether Column <code>F</code> contains the substring <strong>an</strong>. Firstly, let&rsquo;s try the <code>apply</code> function:</p>

<pre><code class="language-python">In [9]: %timeit df[&quot;G&quot;] = df.apply(lambda x: 1 if &quot;an&quot; in x[&quot;F&quot;] else 0, axis=1)
61.1 ms ± 685 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
</code></pre>

<p>Now, if we use the second approach:</p>

<pre><code class="language-python">In [10]: %timeit df[&quot;H&quot;] = np.where(df[&quot;F&quot;].str.contains(&quot;an&quot;), 1, 0)
2.65 ms ± 40.9 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</code></pre>

<p>which is ~30 times faster.</p>

<p>The conclusion is that whenever we can operate on the whole column, we should avoid using <code>apply</code>, which is looping over every row of the DataFrame, and is not able to take advantage of numpy vectorization when performing the calculation.</p>

      
      
      
    </article>
    
    
 <aside><div id="disqus_thread"></div></aside>

<script type="text/javascript">
     
    var disqus_shortname = 'albertauyeung';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



    
  </main>
  
  <nav class="pagination-single">
    <center>
      <a href="#">Back to Top</a>
    </center>
    
  </nav>


  
  <footer role="contentinfo">
    <div style="text-align:center; font-size: 0.8em">
      Copyright © 2017 Albert Au Yeung. All Rights Reserved.
    </div>
  </footer>


</div>

<script src="../../js/jquery-3.2.1.min.js"></script>
<script src="../../js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    },
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>
<script src="../../../cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJaxdda6.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<script>
$(document).ready(function() {
  var links = document.querySelectorAll('article a');
    for (var i = 0, length = links.length; i < length; i++) {
      if (links[i].hostname != window.location.hostname) {
        links[i].target = '_blank';
      }
  }
});
</script>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','../../../www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-30554548-1', 'auto');
	ga('send', 'pageview');
</script>

</body>

<!-- Mirrored from www.albertauyeung.com/post/fast-operation-pandas/ by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 02 Nov 2018 14:48:01 GMT -->
</html>

